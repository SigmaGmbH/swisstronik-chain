#!/bin/bash

CHAINID="swisstronik_1291-1"
MONIKER="localtestnet"
KEYRING="test"
KEYALGO="eth_secp256k1"
HOMEDIR="$HOME/.swisstronik"
BINARY="./build/swisstronikd"

if [[ -z "$SWTR_BINARY" ]]; then
  BINARY="./build/swisstronikd"
else
  BINARY="${SWTR_BINARY}"
fi

# Path variables
CONFIG=$HOMEDIR/config/config.toml
APP_TOML=$HOMEDIR/config/app.toml
GENESIS=$HOMEDIR/config/genesis.json
TMP_GENESIS=$HOMEDIR/config/tmp_genesis.json

# Compliance proxy contract
COMPLIANCE_PROXY_BYTECODE="608060405234801561000f575f80fd5b5060043610610086575f3560e01c806395183eb71161005957806395183eb714610126578063ace417e014610156578063d832c2f014610186578063d916d4e2146101b657610086565b80633fccb7481461008a57806344e48ac6146100a85780636be006d4146100c65780638cc2551d146100f6575b5f80fd5b6100926101d4565b60405161009f9190610ad8565b60405180910390f35b6100b0610298565b6040516100bd9190610ad8565b60405180910390f35b6100e060048036038101906100db9190610b63565b61035c565b6040516100ed9190610ad8565b60405180910390f35b610110600480360381019061010b9190610bc1565b6105a2565b60405161011d9190610ad8565b60405180910390f35b610140600480360381019061013b9190610b63565b610773565b60405161014d9190610e74565b60405180910390f35b610170600480360381019061016b9190610b63565b610866565b60405161017d9190610eae565b60405180910390f35b6101a0600480360381019061019b9190611007565b610966565b6040516101ad9190610eae565b60405180910390f35b6101be610a63565b6040516101cb9190611070565b60405180910390f35b60605f604051602401604051602081830303815290604052633db94a0460e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff168360405161024d91906110c3565b5f60405180830381855afa9150503d805f8114610285576040519150601f19603f3d011682016040523d82523d5f602084013e61028a565b606091505b509150915080935050505090565b60605f60405160240160405160208183030381529060405263d0376bd260e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff168360405161031191906110c3565b5f60405180830381855afa9150503d805f8114610349576040519150601f19603f3d011682016040523d82523d5f602084013e61034e565b606091505b509150915080935050505090565b60605f600167ffffffffffffffff81111561037a57610379610ecb565b5b6040519080825280601f01601f1916602001820160405280156103ac5781602001600182028036833780820191505090505b5090505f6040518060400160405280600c81526020017f636861696e5f313239312d31000000000000000000000000000000000000000081525090505f6040518060400160405280600681526020017f736368656d61000000000000000000000000000000000000000000000000000081525090505f6040518060400160405280601481526020017f697373756572566572696669636174696f6e496400000000000000000000000081525090505f808785600264010000000042610471919061110f565b5f8a89898960405160240161048e999897969594939291906111d8565b60405160208183030381529060405263e62364ab60e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff16836040516104fe91906110c3565b5f604051808303815f865af19150503d805f8114610537576040519150601f19603f3d011682016040523d82523d5f602084013e61053c565b606091505b50915091505f818060200190518101906105569190611321565b90507f109923c5f814b7944f9591557d6a8d1dde907b5cc4cebccf84d59959347589bc8382604051610589929190611368565b60405180910390a1809950505050505050505050919050565b60605f600167ffffffffffffffff8111156105c0576105bf610ecb565b5b6040519080825280601f01601f1916602001820160405280156105f25781602001600182028036833780820191505090505b5090505f6040518060400160405280601481526020017f697373756572566572696669636174696f6e496400000000000000000000000081525090505f8086600264010000000042610644919061110f565b5f8787878c604051602401610660989796959493929190611439565b60405160208183030381529060405263c220658060e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff16836040516106d091906110c3565b5f604051808303815f865af19150503d805f8114610709576040519150601f19603f3d011682016040523d82523d5f602084013e61070e565b606091505b50915091505f818060200190518101906107289190611321565b90507f109923c5f814b7944f9591557d6a8d1dde907b5cc4cebccf84d59959347589bc838260405161075b929190611368565b60405180910390a18097505050505050505092915050565b60605f82306040516024016107899291906114eb565b60405160208183030381529060405263cc8995ec60e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff16836040516107f991906110c3565b5f60405180830381855afa9150503d805f8114610831576040519150601f19603f3d011682016040523d82523d5f602084013e610836565b606091505b50915091506060821561085a57818060200190518101906108579190611853565b90505b80945050505050919050565b5f60605f8360025f846040516024016108829493929190611942565b604051602081830303815290604052634887fcd860e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff16836040516108f291906110c3565b5f60405180830381855afa9150503d805f811461092a576040519150601f19603f3d011682016040523d82523d5f602084013e61092f565b606091505b50915091508115610959578080602001905181019061094e91906119b6565b945050505050610961565b5f9450505050505b919050565b5f808360025f856040516024016109809493929190611942565b604051602081830303815290604052634887fcd860e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090505f8061040473ffffffffffffffffffffffffffffffffffffffff16836040516109f091906110c3565b5f60405180830381855afa9150503d805f8114610a28576040519150601f19603f3d011682016040523d82523d5f602084013e610a2d565b606091505b50915091508115610a565780806020019051810190610a4c91906119b6565b9350505050610a5d565b5f93505050505b92915050565b600281565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f610aaa82610a68565b610ab48185610a72565b9350610ac4818560208601610a82565b610acd81610a90565b840191505092915050565b5f6020820190508181035f830152610af08184610aa0565b905092915050565b5f604051905090565b5f80fd5b5f80fd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610b3282610b09565b9050919050565b610b4281610b28565b8114610b4c575f80fd5b50565b5f81359050610b5d81610b39565b92915050565b5f60208284031215610b7857610b77610b01565b5b5f610b8584828501610b4f565b91505092915050565b5f819050919050565b610ba081610b8e565b8114610baa575f80fd5b50565b5f81359050610bbb81610b97565b92915050565b5f8060408385031215610bd757610bd6610b01565b5b5f610be485828601610b4f565b9250506020610bf585828601610bad565b9150509250929050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f63ffffffff82169050919050565b610c4081610c28565b82525050565b5f82825260208201905092915050565b5f610c6082610a68565b610c6a8185610c46565b9350610c7a818560208601610a82565b610c8381610a90565b840191505092915050565b610c9781610b28565b82525050565b5f81519050919050565b5f82825260208201905092915050565b5f610cc182610c9d565b610ccb8185610ca7565b9350610cdb818560208601610a82565b610ce481610a90565b840191505092915050565b5f61014083015f830151610d055f860182610c37565b5060208301518482036020860152610d1d8282610c56565b9150506040830151610d326040860182610c8e565b5060608301518482036060860152610d4a8282610cb7565b9150506080830151610d5f6080860182610c37565b5060a0830151610d7260a0860182610c37565b5060c083015184820360c0860152610d8a8282610c56565b91505060e083015184820360e0860152610da48282610cb7565b915050610100830151848203610100860152610dc08282610cb7565b915050610120830151610dd7610120860182610c37565b508091505092915050565b5f610ded8383610cef565b905092915050565b5f602082019050919050565b5f610e0b82610bff565b610e158185610c09565b935083602082028501610e2785610c19565b805f5b85811015610e625784840389528151610e438582610de2565b9450610e4e83610df5565b925060208a01995050600181019050610e2a565b50829750879550505050505092915050565b5f6020820190508181035f830152610e8c8184610e01565b905092915050565b5f8115159050919050565b610ea881610e94565b82525050565b5f602082019050610ec15f830184610e9f565b92915050565b5f80fd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b610f0182610a90565b810181811067ffffffffffffffff82111715610f2057610f1f610ecb565b5b80604052505050565b5f610f32610af8565b9050610f3e8282610ef8565b919050565b5f67ffffffffffffffff821115610f5d57610f5c610ecb565b5b602082029050602081019050919050565b5f80fd5b5f610f84610f7f84610f43565b610f29565b90508083825260208201905060208402830185811115610fa757610fa6610f6e565b5b835b81811015610fd05780610fbc8882610b4f565b845260208401935050602081019050610fa9565b5050509392505050565b5f82601f830112610fee57610fed610ec7565b5b8135610ffe848260208601610f72565b91505092915050565b5f806040838503121561101d5761101c610b01565b5b5f61102a85828601610b4f565b925050602083013567ffffffffffffffff81111561104b5761104a610b05565b5b61105785828601610fda565b9150509250929050565b61106a81610c28565b82525050565b5f6020820190506110835f830184611061565b92915050565b5f81905092915050565b5f61109d82610a68565b6110a78185611089565b93506110b7818560208601610a82565b80840191505092915050565b5f6110ce8284611093565b915081905092915050565b5f819050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f611119826110d9565b9150611124836110d9565b925082611134576111336110e2565b5b828206905092915050565b61114881610b28565b82525050565b5f82825260208201905092915050565b5f61116882610c9d565b611172818561114e565b9350611182818560208601610a82565b61118b81610a90565b840191505092915050565b5f819050919050565b5f819050919050565b5f6111c26111bd6111b884611196565b61119f565b610c28565b9050919050565b6111d2816111a8565b82525050565b5f610120820190506111ec5f83018c61113f565b81810360208301526111fe818b61115e565b905061120d604083018a611061565b61121a6060830189611061565b61122760808301886111c9565b81810360a08301526112398187610aa0565b905081810360c083015261124d818661115e565b905081810360e0830152611261818561115e565b9050611271610100830184611061565b9a9950505050505050505050565b5f80fd5b5f67ffffffffffffffff82111561129d5761129c610ecb565b5b6112a682610a90565b9050602081019050919050565b5f6112c56112c084611283565b610f29565b9050828152602081018484840111156112e1576112e061127f565b5b6112ec848285610a82565b509392505050565b5f82601f83011261130857611307610ec7565b5b81516113188482602086016112b3565b91505092915050565b5f6020828403121561133657611335610b01565b5b5f82015167ffffffffffffffff81111561135357611352610b05565b5b61135f848285016112f4565b91505092915050565b5f60408201905061137b5f830185610e9f565b818103602083015261138d8184610aa0565b90509392505050565b7f636861696e5f313239312d3100000000000000000000000000000000000000005f82015250565b5f6113ca600c8361114e565b91506113d582611396565b602082019050919050565b7f736368656d6100000000000000000000000000000000000000000000000000005f82015250565b5f61141460068361114e565b915061141f826113e0565b602082019050919050565b61143381610b8e565b82525050565b5f6101408201905061144d5f83018b61113f565b818103602083015261145e816113be565b905061146d604083018a611061565b61147a6060830189611061565b61148760808301886111c9565b81810360a08301526114998187610aa0565b905081810360c08301526114ac81611408565b905081810360e08301526114c0818661115e565b90506114d0610100830185611061565b6114de61012083018461142a565b9998505050505050505050565b5f6040820190506114fe5f83018561113f565b61150b602083018461113f565b9392505050565b5f67ffffffffffffffff82111561152c5761152b610ecb565b5b602082029050602081019050919050565b5f80fd5b5f80fd5b61154e81610c28565b8114611558575f80fd5b50565b5f8151905061156981611545565b92915050565b5f8151905061157d81610b39565b92915050565b5f67ffffffffffffffff82111561159d5761159c610ecb565b5b6115a682610a90565b9050602081019050919050565b5f6115c56115c084611583565b610f29565b9050828152602081018484840111156115e1576115e061127f565b5b6115ec848285610a82565b509392505050565b5f82601f83011261160857611607610ec7565b5b81516116188482602086016115b3565b91505092915050565b5f61014082840312156116375761163661153d565b5b611642610140610f29565b90505f6116518482850161155b565b5f83015250602082015167ffffffffffffffff81111561167457611673611541565b5b611680848285016112f4565b60208301525060406116948482850161156f565b604083015250606082015167ffffffffffffffff8111156116b8576116b7611541565b5b6116c4848285016115f4565b60608301525060806116d88482850161155b565b60808301525060a06116ec8482850161155b565b60a08301525060c082015167ffffffffffffffff8111156117105761170f611541565b5b61171c848285016112f4565b60c08301525060e082015167ffffffffffffffff8111156117405761173f611541565b5b61174c848285016115f4565b60e08301525061010082015167ffffffffffffffff81111561177157611770611541565b5b61177d848285016115f4565b610100830152506101206117938482850161155b565b6101208301525092915050565b5f6117b26117ad84611512565b610f29565b905080838252602082019050602084028301858111156117d5576117d4610f6e565b5b835b8181101561181c57805167ffffffffffffffff8111156117fa576117f9610ec7565b5b8086016118078982611621565b855260208501945050506020810190506117d7565b5050509392505050565b5f82601f83011261183a57611839610ec7565b5b815161184a8482602086016117a0565b91505092915050565b5f6020828403121561186857611867610b01565b5b5f82015167ffffffffffffffff81111561188557611884610b05565b5b61189184828501611826565b91505092915050565b5f81519050919050565b5f82825260208201905092915050565b5f819050602082019050919050565b5f6118ce8383610c8e565b60208301905092915050565b5f602082019050919050565b5f6118f08261189a565b6118fa81856118a4565b9350611905836118b4565b805f5b8381101561193557815161191c88826118c3565b9750611927836118da565b925050600181019050611908565b5085935050505092915050565b5f6080820190506119555f83018761113f565b6119626020830186611061565b61196f60408301856111c9565b818103606083015261198181846118e6565b905095945050505050565b61199581610e94565b811461199f575f80fd5b50565b5f815190506119b08161198c565b92915050565b5f602082840312156119cb576119ca610b01565b5b5f6119d8848285016119a2565b9150509291505056fea2646970667358221220e2acc2418f8d37c68a573935ed6868267b81fcabbed5f726450ef2a3d8d521d964736f6c634300081a0033"
COMPLIANCE_PROXY_CODEHASH="0xd05a753f154927b7c7c93019c83ebedd132958de6131661d0cb29c2939abf271"

# validate dependencies are installed
command -v jq >/dev/null 2>&1 || {
	echo >&2 "jq not installed. More info: https://stedolan.github.io/jq/download/"
	exit 1
}

# used to exit on first error (any non-zero exit code)
set -e

rm -rf "$HOMEDIR"

$BINARY config keyring-backend $KEYRING --home "$HOMEDIR"
$BINARY config chain-id $CHAINID --home "$HOMEDIR"

echo "betray theory cargo way left cricket doll room donkey wire reunion fall left surprise hamster corn village happy bulb token artist twelve whisper expire" | $BINARY keys add alice --keyring-backend $KEYRING --home $HOMEDIR --recover
echo "toss sense candy point cost rookie jealous snow ankle electric sauce forward oblige tourist stairs horror grunt tenant afford master violin final genre reason" | $BINARY keys add bob --keyring-backend $KEYRING --home $HOMEDIR --recover
echo "offer feel open ancient relax habit field right evoke ball organ beauty" | $BINARY keys add test1 --recover  --keyring-backend $KEYRING --home "$HOMEDIR"
echo "olympic such citizen any bind small neutral hidden prefer pupil trash lemon" | $BINARY keys add test2 --recover  --keyring-backend $KEYRING --home "$HOMEDIR"
echo "cup hip eyebrow flock slogan filter gas tent angle purpose rose setup" | $BINARY keys add operator --recover --keyring-backend $KEYRING --home "$HOMEDIR"

$BINARY init $MONIKER -o --chain-id $CHAINID --home "$HOMEDIR"

jq '.app_state["feemarket"]["params"]["base_fee"]="7"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["staking"]["params"]["bond_denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["staking"]["params"]["unbonding_time"]="1s"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["crisis"]["constant_fee"]["denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["gov"]["deposit_params"]["min_deposit"][0]["denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["gov"]["params"]["min_deposit"][0]["denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["evm"]["params"]["evm_denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["inflation"]["params"]["mint_denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["mint"]["params"]["mint_denom"]="aswtr"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.consensus_params["block"]["max_gas"]="10000000"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state["compliance"]["operators"]=[{"operator":"swtr1ml2knanpk8sv94f8h9g8vaf9k3yyfva4fykyn9", "operator_type": 1}]' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# set initial issuer in genesis
jq --arg BYTECODE $COMPLIANCE_PROXY_BYTECODE '.app_state.evm.accounts += [{"address":"0x2Fc0B35E41a9a2eA248a275269Af1c8B3a061167", "code": $BYTECODE, "storage": []}]' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.compliance.issuerDetails += [{"address": "swtr19lqtxhjp4x3w5fy2yafxntcu3vaqvyt827e4ct", "details": {"creator": "swtr1ml2knanpk8sv94f8h9g8vaf9k3yyfva4fykyn9", "description": "d", "legalEntity": "e", "logo": "l", "name": "n", "url": "u"}}]' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.compliance.addressDetails += [{"address": "swtr19lqtxhjp4x3w5fy2yafxntcu3vaqvyt827e4ct", "details": {"is_revoked": false, "is_verified": true, "verifications": []}}]' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq --arg CODE_HASH $COMPLIANCE_PROXY_CODEHASH '.app_state.auth.accounts += [{"@type": "/ethermint.types.v1.EthAccount", "base_account": {"account_number": "5", "address": "swtr19lqtxhjp4x3w5fy2yafxntcu3vaqvyt827e4ct", "pub_key": null, "sequence": "1" }, "code_hash": $CODE_HASH}]' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# disable node logs. remove this line if you need all logs
sed -i 's/info/error/g' "$CONFIG"

# expose ports
sed -i 's/127.0.0.1:26657/0.0.0.0:26657/g' "$CONFIG"
sed -i 's/127.0.0.1:8545/0.0.0.0:8545/g' "$APP_TOML"
sed -i 's/127.0.0.1:8546/0.0.0.0:8546/g' "$APP_TOML"

# enable prometheus metrics
sed -i 's/prometheus = false/prometheus = true/' "$CONFIG"
sed -i 's/prometheus-retention-time  = "0"/prometheus-retention-time  = "1000000000000"/g' "$APP_TOML"
sed -i 's/enabled = false/enabled = true/g' "$APP_TOML"

# disable unsafe eth endpoints
sed -i 's/unsafe-eth-endpoints-enabled = true/unsafe-eth-endpoints-enabled = false/' "$APP_TOML"

# set min gas price
sed -i 's/minimum-gas-prices = ""/minimum-gas-prices = "0aswtr"/' "$APP_TOML"

# Change proposal periods to pass within a reasonable time for local testing
sed -i.bak 's/"max_deposit_period": "172800s"/"max_deposit_period": "30s"/g' "$HOMEDIR"/config/genesis.json
sed -i.bak 's/"voting_period": "172800s"/"voting_period": "30s"/g' "$HOMEDIR"/config/genesis.json

# set custom pruning settings
sed -i.bak 's/pruning = "default"/pruning = "custom"/g' "$APP_TOML"
sed -i.bak 's/pruning-keep-recent = "0"/pruning-keep-recent = "100"/g' "$APP_TOML"
sed -i.bak 's/pruning-interval = "0"/pruning-interval = "500"/g' "$APP_TOML"

# Allocate genesis accounts
$BINARY add-genesis-account alice 100000000swtr --keyring-backend $KEYRING --home "$HOMEDIR"
$BINARY add-genesis-account bob 100000000swtr --keyring-backend $KEYRING --home "$HOMEDIR"
$BINARY add-genesis-account test1 100000000swtr --keyring-backend $KEYRING --home "$HOMEDIR"
$BINARY add-genesis-account test2 100000000swtr --keyring-backend $KEYRING --home "$HOMEDIR"
$BINARY add-genesis-account operator 100000000swtr --keyring-backend $KEYRING --home "$HOMEDIR"

# Sign genesis transaction
$BINARY gentx alice 1000000000000000000000aswtr --keyring-backend $KEYRING --chain-id $CHAINID --home "$HOMEDIR"

# Collect genesis tx
$BINARY collect-gentxs --home "$HOMEDIR"

# Run this to ensure everything worked and that the genesis file is setup correctly
$BINARY validate-genesis --home "$HOMEDIR"

# Initialize epoch keys for local testnet
$BINARY testnet init-testnet-enclave