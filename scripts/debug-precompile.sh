#!/bin/bash

# This script is to deploy ComplianceProxy contract for ComplianceBridge unit test under `tests/solidity`.
# ComplianceProxy is an example of issuer contract which needs to be added and verified before verifying users.
#
# Steps:
# - Deploy ComplianceProxy contract with alice wallet by sending raw tx bytes, alice must have nonce 1
# - Get the deployed contract address and use it as issuer address
# - Add new issuer for testing with dummy data and set its verification status

HOMEDIR=~/.swisstronik
KEYRING="test"

set -e

function wait_for_tx () {
    echo -e "\nWaiting for sync tx...\n"
    sleep 3 # wait 3 seconds
}

# Deploy ComplianceProxy contract and get transaction hash
echo "Deploying ComplianceProxy contract..."
RAW_BYTES=0x02f9146282050b018459682f00846e79f89c831192e98080b91407608060405234801561001057600080fd5b506113e7806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80636be006d41461005c57806395183eb714610078578063ace417e0146100a8578063d832c2f0146100d8578063d916d4e214610108575b600080fd5b610076600480360381019061007191906106d3565b610126565b005b610092600480360381019061008d91906106d3565b610358565b60405161009f919061099a565b60405180910390f35b6100c260048036038101906100bd91906106d3565b610450565b6040516100cf91906109d7565b60405180910390f35b6100f260048036038101906100ed9190610b3a565b610558565b6040516100ff91906109d7565b60405180910390f35b61011061065c565b60405161011d9190610ba5565b60405180910390f35b6000600167ffffffffffffffff811115610143576101426109f7565b5b6040519080825280601f01601f1916602001820160405280156101755781602001600182028036833780820191505090505b50905060006040518060400160405280600c81526020017f636861696e5f313239312d310000000000000000000000000000000000000000815250905060006040518060400160405280600681526020017f736368656d610000000000000000000000000000000000000000000000000000815250905060006040518060400160405280601481526020017f697373756572566572696669636174696f6e49640000000000000000000000008152509050600080868560026401000000004261023e9190610bf9565b60008a89898960405160240161025c99989796959493929190610d12565b60405160208183030381529060405263e62364ab60e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050905060008061040473ffffffffffffffffffffffffffffffffffffffff16836040516102cd9190610df7565b6000604051808303816000865af19150503d806000811461030a576040519150601f19603f3d011682016040523d82523d6000602084013e61030f565b606091505b50915091507f109923c5f814b7944f9591557d6a8d1dde907b5cc4cebccf84d59959347589bc8282604051610345929190610e0e565b60405180910390a1505050505050505050565b60606000823060405160240161036f929190610e3e565b60405160208183030381529060405263cc8995ec60e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050905060008061040473ffffffffffffffffffffffffffffffffffffffff16836040516103e09190610df7565b600060405180830381855afa9150503d806000811461041b576040519150601f19603f3d011682016040523d82523d6000602084013e610420565b606091505b50915091506060821561044457818060200190518101906104419190611214565b90505b80945050505050919050565b60006060600083600260008460405160240161046f949392919061130c565b604051602081830303815290604052634887fcd860e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050905060008061040473ffffffffffffffffffffffffffffffffffffffff16836040516104e09190610df7565b600060405180830381855afa9150503d806000811461051b576040519150601f19603f3d011682016040523d82523d6000602084013e610520565b606091505b5091509150811561054a578080602001905181019061053f9190611384565b945050505050610553565b60009450505050505b919050565b600080836002600085604051602401610574949392919061130c565b604051602081830303815290604052634887fcd860e01b6020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050905060008061040473ffffffffffffffffffffffffffffffffffffffff16836040516105e59190610df7565b600060405180830381855afa9150503d8060008114610620576040519150601f19603f3d011682016040523d82523d6000602084013e610625565b606091505b5091509150811561064e57808060200190518101906106449190611384565b9350505050610656565b600093505050505b92915050565b600281565b6000604051905090565b600080fd5b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006106a082610675565b9050919050565b6106b081610695565b81146106bb57600080fd5b50565b6000813590506106cd816106a7565b92915050565b6000602082840312156106e9576106e861066b565b5b60006106f7848285016106be565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b61073581610695565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561077557808201518184015260208101905061075a565b60008484015250505050565b6000601f19601f8301169050919050565b600061079d8261073b565b6107a78185610746565b93506107b7818560208601610757565b6107c081610781565b840191505092915050565b600063ffffffff82169050919050565b6107e4816107cb565b82525050565b600081519050919050565b600082825260208201905092915050565b6000610811826107ea565b61081b81856107f5565b935061082b818560208601610757565b61083481610781565b840191505092915050565b600061010083016000830151610858600086018261072c565b50602083015184820360208601526108708282610792565b915050604083015161088560408601826107db565b50606083015161089860608601826107db565b50608083015184820360808601526108b08282610806565b91505060a083015184820360a08601526108ca8282610792565b91505060c083015184820360c08601526108e48282610792565b91505060e08301516108f960e08601826107db565b508091505092915050565b6000610910838361083f565b905092915050565b6000602082019050919050565b600061093082610700565b61093a818561070b565b93508360208202850161094c8561071c565b8060005b8581101561098857848403895281516109698582610904565b945061097483610918565b925060208a01995050600181019050610950565b50829750879550505050505092915050565b600060208201905081810360008301526109b48184610925565b905092915050565b60008115159050919050565b6109d1816109bc565b82525050565b60006020820190506109ec60008301846109c8565b92915050565b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610a2f82610781565b810181811067ffffffffffffffff82111715610a4e57610a4d6109f7565b5b80604052505050565b6000610a61610661565b9050610a6d8282610a26565b919050565b600067ffffffffffffffff821115610a8d57610a8c6109f7565b5b602082029050602081019050919050565b600080fd5b6000610ab6610ab184610a72565b610a57565b90508083825260208201905060208402830185811115610ad957610ad8610a9e565b5b835b81811015610b025780610aee88826106be565b845260208401935050602081019050610adb565b5050509392505050565b600082601f830112610b2157610b206109f2565b5b8135610b31848260208601610aa3565b91505092915050565b60008060408385031215610b5157610b5061066b565b5b6000610b5f858286016106be565b925050602083013567ffffffffffffffff811115610b8057610b7f610670565b5b610b8c85828601610b0c565b9150509250929050565b610b9f816107cb565b82525050565b6000602082019050610bba6000830184610b96565b92915050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b6000610c0482610bc0565b9150610c0f83610bc0565b925082610c1f57610c1e610bca565b5b828206905092915050565b610c3381610695565b82525050565b600082825260208201905092915050565b6000610c558261073b565b610c5f8185610c39565b9350610c6f818560208601610757565b610c7881610781565b840191505092915050565b6000819050919050565b6000819050919050565b6000610cb2610cad610ca884610c83565b610c8d565b6107cb565b9050919050565b610cc281610c97565b82525050565b600082825260208201905092915050565b6000610ce4826107ea565b610cee8185610cc8565b9350610cfe818560208601610757565b610d0781610781565b840191505092915050565b600061012082019050610d28600083018c610c2a565b8181036020830152610d3a818b610c4a565b9050610d49604083018a610b96565b610d566060830189610b96565b610d636080830188610cb9565b81810360a0830152610d758187610cd9565b905081810360c0830152610d898186610c4a565b905081810360e0830152610d9d8185610c4a565b9050610dad610100830184610b96565b9a9950505050505050505050565b600081905092915050565b6000610dd1826107ea565b610ddb8185610dbb565b9350610deb818560208601610757565b80840191505092915050565b6000610e038284610dc6565b915081905092915050565b6000604082019050610e2360008301856109c8565b8181036020830152610e358184610cd9565b90509392505050565b6000604082019050610e536000830185610c2a565b610e606020830184610c2a565b9392505050565b600067ffffffffffffffff821115610e8257610e816109f7565b5b602082029050602081019050919050565b600080fd5b600080fd5b600081519050610eac816106a7565b92915050565b600080fd5b600067ffffffffffffffff821115610ed257610ed16109f7565b5b610edb82610781565b9050602081019050919050565b6000610efb610ef684610eb7565b610a57565b905082815260208101848484011115610f1757610f16610eb2565b5b610f22848285610757565b509392505050565b600082601f830112610f3f57610f3e6109f2565b5b8151610f4f848260208601610ee8565b91505092915050565b610f61816107cb565b8114610f6c57600080fd5b50565b600081519050610f7e81610f58565b92915050565b600067ffffffffffffffff821115610f9f57610f9e6109f7565b5b610fa882610781565b9050602081019050919050565b6000610fc8610fc384610f84565b610a57565b905082815260208101848484011115610fe457610fe3610eb2565b5b610fef848285610757565b509392505050565b600082601f83011261100c5761100b6109f2565b5b815161101c848260208601610fb5565b91505092915050565b6000610100828403121561103c5761103b610e93565b5b611047610100610a57565b9050600061105784828501610e9d565b600083015250602082015167ffffffffffffffff81111561107b5761107a610e98565b5b61108784828501610f2a565b602083015250604061109b84828501610f6f565b60408301525060606110af84828501610f6f565b606083015250608082015167ffffffffffffffff8111156110d3576110d2610e98565b5b6110df84828501610ff7565b60808301525060a082015167ffffffffffffffff81111561110357611102610e98565b5b61110f84828501610f2a565b60a08301525060c082015167ffffffffffffffff81111561113357611132610e98565b5b61113f84828501610f2a565b60c08301525060e061115384828501610f6f565b60e08301525092915050565b600061117261116d84610e67565b610a57565b9050808382526020820190506020840283018581111561119557611194610a9e565b5b835b818110156111dc57805167ffffffffffffffff8111156111ba576111b96109f2565b5b8086016111c78982611025565b85526020850194505050602081019050611197565b5050509392505050565b600082601f8301126111fb576111fa6109f2565b5b815161120b84826020860161115f565b91505092915050565b60006020828403121561122a5761122961066b565b5b600082015167ffffffffffffffff81111561124857611247610670565b5b611254848285016111e6565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b6000611295838361072c565b60208301905092915050565b6000602082019050919050565b60006112b98261125d565b6112c38185611268565b93506112ce83611279565b8060005b838110156112ff5781516112e68882611289565b97506112f1836112a1565b9250506001810190506112d2565b5085935050505092915050565b60006080820190506113216000830187610c2a565b61132e6020830186610b96565b61133b6040830185610cb9565b818103606083015261134d81846112ae565b905095945050505050565b611361816109bc565b811461136c57600080fd5b50565b60008151905061137e81611358565b92915050565b60006020828403121561139a5761139961066b565b5b60006113a88482850161136f565b9150509291505056fea2646970667358221220c4a5f4c6b9fdecfdf911a5ff4160170b256af2c2a2e51104fe89811b7207cdac64736f6c63430008110033c080a02a63feb8739f5dfe1845f291f0841d6f5dd1380618f86a4f71fa76f785fc5dfaa05720632e21bd1714331291541f8a25c68fa3071dbf0a26d8a1ed92f91c5a2415
TXHASH=$(swisstronikd tx evm raw $RAW_BYTES -y --from alice --keyring-backend $KEYRING --home $HOMEDIR --gas-prices 1000000aswtr --output json | jq -r '.txhash')
wait_for_tx
echo -e "\ntxHash: $TXHASH"

# Get ethereum transaction hash
ETH_TXHASH=$(swisstronikd query tx $TXHASH --output json | jq -r '.events[] | select(.type == "ethereum_tx") | .attributes[] | select(.key == "ethereumTxHash") | .value' | head -n 1)
echo -e "\nEthereum txHash: $ETH_TXHASH"

# Get deployed contract address
echo "Sending transaction receipt to get deployed contract address..."
ISSUER=$(curl -s -X POST --data '{"jsonrpc":"2.0","method":"eth_getTransactionReceipt","params":["'"$ETH_TXHASH"'"],"id":1}' -H "Content-Type: application/json" http://localhost:8545 | jq -r '.result.contractAddress')
echo -e "\nContract Address: $ISSUER"

# Add new issuer address for testing
echo -e "\nNew Issuer Address for testing: $ISSUER"
echo "Adding new issuer..."
swisstronikd tx compliance set-issuer-details $ISSUER issuer-name issuer-description issuer-url issuer-logo issuer-legal-entity -y --from operator --keyring-backend $KEYRING --home $HOMEDIR --gas-prices 100000000aswtr --output json | tail -n 1 | jq -r '.txhash'
wait_for_tx
echo "Set verification status for new issuer..."
swisstronikd tx compliance set-issuer-verification $ISSUER true -y --from operator --keyring-backend $KEYRING --home $HOMEDIR --gas-prices 100000000aswtr --output json | tail -n 1 | jq -r '.txhash'
wait_for_tx

echo -e "\n\n##########################\n"
echo "Now you are ready to run unit test with the following command: npm run test:tronik"